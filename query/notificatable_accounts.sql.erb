SELECT
  accounts.id
FROM accounts
  INNER JOIN users ON accounts.id=users.account_id
  LEFT JOIN (
    SELECT
      account_id AS id
    FROM blocks
    WHERE target_account_id='<%= params[:id] %>'
  ) AS block_accounts ON accounts.id=block_accounts.id
  LEFT JOIN (
    SELECT
      account_id AS id
    FROM mutes
    WHERE target_account_id='<%= params[:id] %>'
  ) AS mute_accounts ON accounts.id=mute_accounts.id
WHERE (accounts.domain IS NULL)
  AND (accounts.silenced='f')
  AND (accounts.suspended='f')
  AND (block_accounts.id IS NULL)
  AND (mute_accounts.id IS NULL)
  AND (users.disabled='f')
  <% if params[:pattern] %>
    AND (accounts.username ~ '<%= params[:pattern] %>')
  <% end %>
GROUP BY
  accounts.id
