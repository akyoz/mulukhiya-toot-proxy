SELECT
  accounts.id
FROM accounts
  INNER JOIN users ON accounts.id=users.account_id
  LEFT JOIN (
    SELECT
      account_id
    FROM blocks
    WHERE target_account_id='<%= params[:id] %>'
  ) AS block_users ON accounts.id=block_users.account_id
  LEFT JOIN (
    SELECT
      account_id
    FROM mutes
    WHERE target_account_id='<%= params[:id] %>'
  ) AS mute_users ON accounts.id=mute_users.account_id
WHERE (accounts.domain IS NULL)
  AND (accounts.silenced='f')
  AND (accounts.suspended='f')
  AND (block_users.account_id IS NULL)
  AND (mute_users.account_id IS NULL)
  AND (users.disabled='f')
  <% if params[:pattern] %>
    AND (accounts.username ~ '<%= params[:pattern] %>')
  <% end %>
GROUP BY accounts.id
