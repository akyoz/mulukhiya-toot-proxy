<%# encoding: UTF-8 -%>
SELECT
  coalesce(note.url, concat('/notes/', note.id::varchar)) AS uri,
  note."createdAt" AS created_at,
  "user".username,
  "user".host AS domain,
  "user".name AS display_name,
  note."text",
  note.cw AS spoiler_text
FROM
  note
  INNER JOIN "user" ON note."userId" = "user".id
WHERE ('<%= params[:tag] %>'=any(note.tags))
  AND (note.visibility = 'public')
  AND ("user".username <> '<%= test_account.acct.username %>')
ORDER BY
  created_at DESC
LIMIT <%= params[:limit] %> OFFSET 0
