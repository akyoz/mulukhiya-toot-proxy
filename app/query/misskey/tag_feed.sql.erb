<%# encoding: UTF-8 -%>
SELECT
  coalesce(note.url, concat('/notes/', note.id::varchar)) AS uri,
  note."createdAt" AS created_at,
  "user".username,
  "user".host AS domain,
  note."text",
  note.cw AS spoiler_text
FROM note
  INNER JOIN "user" ON note."userId"="user".id
WHERE (note.tags::varchar ~ '[{,]<%= params[:tag].downcase %>[,}]')
  AND (note.visibility='public')
  AND ("user".username NOT IN (<%= params[:test_usernames].map {|v| %{'#{Mulukhiya::QueryTemplate.escape(v)}'}}.join(',') %>))
ORDER BY created_at DESC
LIMIT <%= params[:limit] %> OFFSET 0